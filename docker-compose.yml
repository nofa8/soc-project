services:
  # =============================
  # APPLICATION & INFRASTRUCTURE
  # =============================
  api-service:
    build: ./backend-fastapi
    container_name: api-service
    volumes:
      - ./logs/api:/app/logs:z
    expose:
      - "8000"

  proxy-nginx:
    image: nginx:alpine
    container_name: proxy-nginx
    user: root
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro,z
      - ./logs/nginx:/var/log/nginx:z
    depends_on:
      - api-service

  db-service:
    image: postgres:15-alpine
    container_name: db-service
    environment:
      POSTGRES_DB: safepay
      POSTGRES_USER: safepay
      POSTGRES_PASSWORD: safepay
    volumes:
      - ./logs/db:/var/log/postgresql:z
    ports:
      - "5432:5432"

  auth-ldap:
    image: osixia/openldap:latest
    container_name: auth-ldap
    environment:
      LDAP_ORGANISATION: "SafePay"
      LDAP_DOMAIN: "safepay.local"
      LDAP_ADMIN_PASSWORD: admin
    volumes:
      - ./logs/ldap:/var/log/ldap:z

  # =============================
  # SECURITY & MONITORING
  # =============================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      default:
        aliases:
          - wazuh.indexer
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'" ]
      interval: 30s
      timeout: 10s
      retries: 5

  ids-suricata:
    image: jasonish/suricata:latest
    container_name: ids-suricata
    user: root
    network_mode: ${SURICATA_NETWORK_MODE:-host} # fallback to host if not set
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    volumes:
      - ./suricata:/etc/suricata:z
      - ./logs/suricata:/var/log/suricata:z
    command: ${SURICATA_COMMAND}

  wazuh-manager:
    image: wazuh/wazuh-manager:4.14.1
    container_name: wazuh-manager
    ports:
      - "1514:1514/tcp"
      - "1515:1515/tcp"
      - "55000:55000"
    volumes:
      - wazuh-data:/var/ossec/data
      - wazuh-logs:/var/ossec/logs/alerts
      - ./config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
      - ./wazuh/custom-rules.xml:/var/ossec/etc/rules/custom_rules.xml:z

  wazuh-agent:
    image: wazuh/wazuh-agent:4.14.1
    container_name: wazuh-agent
    hostname: soc-agent
    environment:
      - WAZUH_MANAGER=wazuh-manager
    volumes:
      - ./config/agent/ossec.conf:/wazuh-config-mount/etc/ossec.conf
      - ./logs:/var/log/soc_logs:ro
    depends_on:
      - wazuh-manager

  # =============================
  # SIEM & VISUALIZATION
  # =============================
  # elasticsearch: Moved to SECURITY & MONITORING section above (aliased as wazuh.indexer)

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - XPACK_SECURITY_ENABLED=false
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=UfR2qXwQJQ8UgAfs/Ayz5IJ3rsCwmhBrAbJ0AKH8h88=
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.1
    container_name: filebeat
    user: root
    command: [ "filebeat", "-e", "-strict.perms=false" ]
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro,z
      - ./logs:/logs:ro,z
      - wazuh-logs:/usr/share/filebeat/wazuh-logs/alerts:ro

volumes:
  wazuh-data:
  elasticsearch-data:
  wazuh-logs:
