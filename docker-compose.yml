services:
  # =============================
  # APPLICATION & INFRASTRUCTURE
  # =============================
  api-service:
    build: ./backend-fastapi
    container_name: api-service
    volumes:
      - ./logs/api:/app/logs:z
    expose:
      - "8000"

  proxy-nginx:
    image: nginx:alpine
    container_name: proxy-nginx
    user: root
    restart: on-failure
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro,z
      - ./logs/nginx:/var/log/nginx:z
    depends_on:
      - kibana
      - api-service

  db-service:
    image: postgres:15-alpine
    container_name: db-service
    environment:
      POSTGRES_DB: safepay
      POSTGRES_USER: safepay
      POSTGRES_PASSWORD: safepay
    volumes:
      - ./logs/db:/var/log/postgresql:z
    expose:
      - "5432"

  # ========================
  # AUTHENTICATION SERVICES
  # ========================
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    command:
      - start-dev
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/import:/opt/keycloak/data/import
    depends_on:
      - auth-ldap

  ldap-admin:
    image: osixia/phpldapadmin:latest
    container_name: ldap-admin
    environment:
      - PHPLDAPADMIN_HTTPS=false
      - PHPLDAPADMIN_LDAP_HOSTS=auth-ldap
      - PHPLDAPADMIN_ALLOW_REMOTE=true
    ports:
      - "6443:80"
    depends_on:
      - auth-ldap

  auth-ldap:
    image: osixia/openldap:latest
    container_name: auth-ldap
    command: ["--copy-service"]
    environment:
      LDAP_ORGANISATION: "SafePay"
      LDAP_DOMAIN: "safepay.local"
      LDAP_ADMIN_PASSWORD: admin
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ./logs/ldap:/var/log/ldap:z
      - ./ldap:/container/service/slapd/assets/config/bootstrap/ldif/custom

  # =============================
  # SECURITY & MONITORING
  # =============================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: elasticsearch
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - ELASTIC_PASSWORD=changeme
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./config/elasticsearch-keystore:/usr/share/elasticsearch/config/elasticsearch-keystore:ro
      - ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
      - elasticsearch-data:/usr/share/elasticsearch/data
    expose:
      - "9200"
    networks:
      default:
        aliases:
          - wazuh.indexer
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -u elastic:changeme -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'",
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  ids-suricata:
    image: jasonish/suricata:latest
    container_name: ids-suricata
    user: root
    network_mode: ${SURICATA_NETWORK_MODE:-host}
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    volumes:
      - ./suricata:/etc/suricata:z
      - ./logs/suricata:/var/log/suricata:z
      - ./pcap:/pcap:ro
    entrypoint: ["/etc/suricata/entrypoint.sh"]
    command: ${SURICATA_COMMAND}

  wazuh-manager:
    image: wazuh/wazuh-manager:4.14.1
    container_name: wazuh-manager
    expose:
      - "1514/tcp"
      - "1515/tcp"
      - "55000"
    volumes:
      - wazuh-data:/var/ossec/data
      - wazuh-logs:/var/ossec/logs/alerts
      - ./config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
      - ./wazuh/custom-rules.xml:/var/ossec/etc/rules/custom_rules.xml:z
      - ./wazuh/local_internal_options.conf:/var/ossec/etc/local_internal_options.conf:z
      - ./config/wazuh_manager/filebeat-service:/etc/services.d/filebeat:ro

  wazuh-agent:
    image: wazuh/wazuh-agent:4.14.1
    container_name: wazuh-agent
    hostname: soc-agent
    environment:
      - WAZUH_MANAGER=wazuh-manager
    volumes:
      - ./config/agent/ossec.conf:/var/ossec/etc/ossec.conf:z
      - ./logs:/var/log/soc_logs:ro
    depends_on:
      - wazuh-manager

  # =============================
  # SIEM & VISUALIZATION
  # =============================
  # elasticsearch: Moved to SECURITY & MONITORING section above (aliased as wazuh.indexer)

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: kibana
    environment:
      - SERVER_BASEPATH=/kibana
      - SERVER_REWRITEBASEPATH=true
      # - ELASTICSEARCH_USERNAME=${KIBANA_SYSTEM_USER}
      # - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
    expose:
      - "5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.1
    container_name: filebeat
    user: root
    #environment:
    #  - ELASTICSEARCH_HOST=http://wazuh.indexer:9200
    command: ["filebeat", "-e", "-strict.perms=false"]
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro,z
      - ./logs:/logs:ro,z
      - wazuh-logs:/usr/share/filebeat/wazuh-logs/alerts:ro

volumes:
  wazuh-data:
  elasticsearch-data:
  wazuh-logs:
