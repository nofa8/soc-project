version: "3.9"

services:
  # =============================
  # APPLICATION & INFRASTRUCTURE
  # =============================
  api-service:
    build: ./backend-fastapi
    container_name: api-service
    volumes:
      - ./logs/api:/app/logs
    expose:
      - "8000"

  proxy-nginx:
    image: nginx:alpine
    container_name: proxy-nginx
    user: root
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api-service

  db-service:
    image: postgres:15-alpine
    container_name: db-service
    environment:
      POSTGRES_DB: safepay
      POSTGRES_USER: safepay
      POSTGRES_PASSWORD: safepay
    volumes:
      - ./logs/db:/var/log/postgresql
    ports:
      - "5432:5432"

  auth-ldap:
    image: osixia/openldap:latest
    container_name: auth-ldap
    environment:
      LDAP_ORGANISATION: "SafePay"
      LDAP_DOMAIN: "safepay.local"
      LDAP_ADMIN_PASSWORD: admin
    volumes:
      - ./logs/ldap:/var/log/ldap

  # =============================
  # SECURITY & MONITORING
  # =============================

  ids-suricata:
    image: jasonish/suricata:latest
    container_name: ids-suricata
    user: root
    network_mode: host
    volumes:
      - ./suricata:/etc/suricata
      - ./logs/suricata:/var/log/suricata
    command: -i eth0

  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.2
    container_name: wazuh-manager
    ports:
      - "1514:1514/udp"
      - "55000:55000"
    volumes:
      - wazuh-data:/var/ossec/data
      - ./wazuh/custom-rules.xml:/var/ossec/etc/rules/custom_rules.xml

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.1
    container_name: filebeat
    user: root
    depends_on:
      - wazuh-manager
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logs:/logs:ro
    command: filebeat -e

volumes:
  wazuh-data:
